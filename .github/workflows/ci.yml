name: Supreme MBP Litigation OS CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  PYTHONUNBUFFERED: "1"

jobs:
  build-and-audit:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout repo
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: ğŸš€ Upgrade pip, wheel, setuptools
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: ğŸ“¦ Install Poetry (if pyproject.toml exists)
      run: |
        if [ -f pyproject.toml ]; then
          pip install poetry
          poetry install
        fi

    - name: ğŸ“¦ Install requirements.txt (if present)
      run: |
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: ğŸ” Lint ALL-IN-ONE system
      run: |
        pip install flake8
        flake8 MBP_Omnia_Engine.py --max-line-length=120 --statistics --show-source || true

    - name: ğŸ›ï¸ Run Supreme ALL-IN-ONE Mainframe (with dashboard)
      run: |
        python MBP_Omnia_Engine.py
      timeout-minutes: 20

    - name: ğŸ§ª Run pytest (if any test exists)
      run: |
        if [ -d tests ]; then
          pip install pytest
          pytest --maxfail=2 --disable-warnings
        fi

    - name: ğŸ“‘ Upload system output/logs/artifacts (audit-proof)
      uses: actions/upload-artifact@v4
      with:
        name: output
        path: |
          output/
          !**/__pycache__/
          !**/*.pyc
          !**/*.pyo
        if-no-files-found: ignore

    - name: ğŸ“Š Upload live dashboard artifact (HTML)
      uses: actions/upload-artifact@v4
      with:
        name: dashboard
        path: output/dashboard.html
        if-no-files-found: ignore

    - name: ğŸ” Upload audit summary (legal proof)
      uses: actions/upload-artifact@v4
      with:
        name: audit
        path: output/supreme_audit.json
        if-no-files-found: ignore

    - name: ğŸ•µï¸â€â™‚ï¸ Post-run: Show last 40 lines of main log
      if: always()
      run: |
        tail -n 40 output/allinone_run.log || echo "Log not found"
